{% extends 'service/base.html' %}
{% block content %}
<h1 style='text-align: center;'>スタッフ検索</h1>
<div style="text-align: center;">
    <a href="{% url 'service:index' %}">TOPページに戻る</a>
</div>


{# 検索内容の表示 #}
<form id="search">
    {# 各labelタグの生成 #}
    {% for item_key, item_value in item_dict.items %}
    <!-- label設定 -->
    <label for="{{item_key}}">{{item_value.called}}:</label>

    {# 各入力項目の作成 #}
    <!-- 入力項目 -->
    {% if item_value.type|stringformat:"s" == "select" %}

    {# 選択肢の作成 #}
    <select name="{{item_key}}" id="{{item_key}}" required>
        {# オプションタグの生成 #}
        {% for v_key, v_value in item_value.contents.items %}
        <option value="{{v_key}}">{{v_value}}</option>
        {% endfor %}
    </select>

    {% elif item_value.type|stringformat:"s" == "number" %}
    {# 数字入力欄の作成 #}
    <input type="number" name="{{item_key}}" id="{{item_key}}" />以下 (条件無しの場合、入力不要)

    {% elif item_value.type|stringformat:"s" == "text" %}
    {# 文字入力欄の作成 #}
    <input type="text" name="{{item_key}}" id="{{item_key}}" /> (条件無しの場合、入力不要)
    {% endif %}

    <hr>
    {% endfor %}

    <button type="submit">検索</button>
</form>


{# 検索結果の表示 #}
<section>
    <h2>検索結果</h2>
    <!-- <table>
        <thead>
        </thead>
    </table> -->

    <div id="result">
    </div>
</section>


<script>
    const searchElm = document.getElementById('search');
    const resultElm = document.getElementById('result');
    {% autoescape off %}
    const item_dict = {{ item_dict }};
    {% endautoescape %}


    searchElm.addEventListener('submit', (e) => {
        // イベントをキャンセル
        e.preventDefault();

        // formに入力されたデータの取得
        const formData = new FormData(searchElm);

        // CSRF に関する処理
        // 参考URL : https://zenn.dev/hathle/articles/django-fetch
        const getCookie = (name) => {
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')) {
                    const [key, value] = cookie.trim().split('=')
                    if (key === name) {
                        return decodeURIComponent(value)
                    }
                }
            }
        }
        const csrftoken = getCookie('csrftoken')

        const execSearch = async () => {
            // APIを叩く
            const data = await fetch("/search_staff/result", {
                method: "POST",
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            })

            // 受け取ったデータをJSON形式に変換
            const result = await data.json();

            // DOM操作
            const child = document.createElement('div');
            var add_child = '';

            // 検索内容を表示
            for (var key in result.data) {
                var key_name = '';
                var value_name = '';

                // 対応する日本語に変更
                for (var item_key in item_dict) {
                    if (key == item_key) {
                        // キーを日本語に変換
                        key_name = item_dict[key]['called']

                        // 選択内容に応じて日本語に変換
                        if (item_dict[key]['type'] == 'select') {
                            value_name = item_dict[key]['contents'][result.data[key]]
                        } else if (item_dict[key]['type'] == 'number') {
                            value_name = result.data[key]
                        } else if (item_dict[key]['type'] == 'text') {
                            value_name = result.data[key]
                        }

                    } else {
                        continue;
                    }
                }
                add_child += '( ' + key_name + ' : ' + value_name + ' ) ';
            }
            child.innerHTML = '検索結果 : ' + result.number + '人 / 検索条件 : ' + add_child;
            resultElm.appendChild(child)
        }
        execSearch();
    });
</script>


{% endblock %}